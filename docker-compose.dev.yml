services:
  traefik:
    image: traefik:v3.3
    restart: always
    volumes:
      - "./mounts/traefik/conf:/etc/traefik:Z"
      - "./mounts/traefik/acme:/acme:Z"
      - "./mounts/traefik/log:/var/log:Z"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - "./certs:/certs:ro"
    ports:
      - $HTTP_PORT:80
      - $HTTPS_PORT:443
    environment:
      BASE_DOMAIN: $BASE_DOMAIN
    networks:
      - visp-net

  apache:
    image: visp-apache
    build:
      context: "."
      dockerfile: "./docker/apache/Dockerfile"
      args:
        WEBCLIENT_BUILD: ${WEBCLIENT_BUILD:-visp-build}
    restart: unless-stopped
    networks:
      - visp-net
      - octra-net
    environment:
      MODE: dev
      PROJECT_NAME: $COMPOSE_PROJECT_NAME
      LOG_LEVEL: debug
      BASE_DOMAIN: $BASE_DOMAIN
      RSTUDIO_DOMAIN_NAME: rstudio.$BASE_DOMAIN
      HS_API_ACCESS_TOKEN: $VISP_API_ACCESS_TOKEN
      ABS_ROOT_PATH: $ABS_ROOT_PATH
      MONGO_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
      #SSP_SALT: $SSP_SALT
      #SSP_ADMIN_PASSWORD: $SSP_ADMIN_PASSWORD
      TEST_USER_LOGIN_KEY: $TEST_USER_LOGIN_KEY
      ADMIN_EMAIL: $ADMIN_EMAIL
      HTTP_PROTOCOL: $HTTP_PROTOCOL
    volumes:
      #SWAMID
      - "./mounts/apache/saml/swamid/$BASE_DOMAIN/shibboleth2.xml:/etc/shibboleth/shibboleth2.xml:Z"
      - "./mounts/apache/saml/swamid/attribute-map.xml:/etc/shibboleth/attribute-map.xml:Z"
      - "./certs/md-signer2.crt:/etc/shibboleth/md-signer2.crt:Z"
      #GENERAL
      - "./mounts/webapi/logs:/var/log/api:Z"
      - "./mounts/apache/saml/shib.conf:/etc/apache2/conf-enabled/shib.conf:Z"
      - "./mounts/apache/apache/envvars:/etc/apache2/envvars:Z"
      - "./mounts/apache/apache/apache2.conf:/etc/apache2/apache2.conf:Z"
      - "./mounts/apache/apache/vhosts:/etc/apache2/sites-enabled:Z"
      - "./external/webclient:/webclient:Z"
      #- "./external/webclient/dist:/var/www/html:Z"
      #- "./external/webapi:/var/www/webapi:Z"
      # The application expects composer autoload at /var/www/html/api/vendor.
      # In development the host mount of ./external/webclient/dist onto /var/www/html hides any
      # vendor files the image build may have put under /var/www/html/api/vendor, and
      # the repo now keeps composer packages under ./external/webapi/vendor. Mount the host
      # vendor folder into the webroot so PHP can always require 'api/vendor/autoload.php'.
      # This mirrors the runtime layout and avoids needing to create a symlink inside
      # the running container as a temporary hotfix.
      #- "./external/webapi/vendor:/var/www/html/api/vendor:Z"
      - "./mounts/apache/apache/logs/apache2:/var/log/apache2:Z"
      - "./mounts/apache/apache/logs/shibboleth:/var/log/shibboleth:Z"
      - "./mounts/apache/saml/shibd.logger:/etc/shibboleth/shibd.logger:Z"
      - "/var/run/docker.sock:/var/run/docker.sock:Z"
      - "./certs:/etc/certs:Z"
      - "./certs/letsencrypt:/certs/letsencrypt:Z"
      - "./mounts/apache/apache/uploads:/tmp/uploads:Z"
      - "./mounts/apache/apache/php.ini:/etc/php/8.2/apache2/php.ini:Z"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - "./mounts/repositories:/repositories:Z"

  session-manager:
    image: visp-session-manager
    build:
      context: ./external/session-manager
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - 8020:8020
    environment:
      COMPOSE_PROJECT_NAME: $COMPOSE_PROJECT_NAME
      HS_API_ACCESS_TOKEN: $VISP_API_ACCESS_TOKEN
      ABS_ROOT_PATH: $ABS_ROOT_PATH
      RSTUDIO_IMAGE_NAME: "visp-rstudio-session"
      RSTUDIO_PASSWORD: $RSTUDIO_PASSWORD
      JUPYTER_IMAGE_NAME: "visp-jupyter-session"
      MONGO_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
      ACCESS_LIST_ENABLED: $ACCESS_LIST_ENABLED
      EMUDB_INTEGRATION_ENABLED: $EMUDB_INTEGRATION_ENABLED
      LOG_LEVEL: "debug"
      DEVELOPMENT_MODE: "true"
      SESSION_MANAGER_KEEP_CONTAINERS: "true"
      GRADIO_WHISPERX_ENDPOINT: "http://whisper:7860"
      BASIC_AUTH_USERNAME: "whisperuser"
      BASIC_AUTH_PASSWORD: "whisperpass"
    volumes:
      # Source code mount for development hot-reload
      - "./external/session-manager:/session-manager:Z"
      # Data volumes
      - "./mounts/apache/apache/uploads:/tmp/uploads:Z"
      - "./mounts/session-manager/logs:/session-manager/logs:Z"
      - "./mounts/session-manager/unimported_audio:/unimported_audio:Z"
      - "/var/run/docker.sock:/var/run/docker.sock:Z"
      - "./mounts/repositories:/repositories:Z"
      - "./mounts/repository-template:/repository-template:Z"
      - "./mounts/transcription-queued:/transcription-queued:Z"
    depends_on:
      - whisper
    networks:
      - visp-net
      - whisper-net

  emu-webapp:
    image: visp-emu-webapp
    build:
      context: ./docker/emu-webapp
      target: development
    restart: unless-stopped
    ports:
      - 127.0.0.1:9000:9000
    volumes:
      - ./external/EMU-webApp:/app:Z
      - /app/node_modules
    networks:
      - visp-net

  emu-webapp-server:
    image: visp-emu-webapp-server
    build: "./external/emu-webapp-server/docker"
    restart: unless-stopped
    ports:
      - 127.0.0.1:17890:17890
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - "./mounts/repositories:/repositories:Z"
      - "./external/emu-webapp-server:/home/node/app:Z"
    env_file:
      - ./mounts/emu-webapp-server/.env
    environment:
      WS_SERVER_PORT: 17890
      MONGO_URI: mongodb://root:${MONGO_ROOT_PASSWORD}@mongo:27017
      MONGO_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
      MONGO_DB_NAME: visp
      REPOSITORIES_PATH: /repositories
      MEDIA_FILE_BASE_URL: https://emu-webapp.${BASE_DOMAIN}
      LOG_LEVEL: DEBUG
    networks:
      - visp-net

  octra:
    image: visp-octra
    build: "./docker/octra"
    restart: unless-stopped
    volumes:
      - "./mounts/octra/appconfig.json:/usr/local/apache2/htdocs/config/appconfig.json:ro,Z"
      - "./mounts/octra/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro,Z"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    networks:
      - octra-net

  wsrng-server:
    image: visp-wsrng-server
    build:
      context: ./external/wsrng-server
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./external/wsrng-server/.env
    environment:
      - MONGO_PASSWORD=${MONGO_ROOT_PASSWORD}
    volumes:
      # Source code mount for development hot-reload
      - "./external/wsrng-server:/wsrng-server:Z"
      # Data volumes
      - "./mounts/repositories:/repositories:Z"
    networks:
      - visp-net

  mongo:
    image: mongo:6.0.27
    restart: unless-stopped
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
    volumes:
      - "./mounts/mongo/data:/data/db:Z"
      - "./mounts/mongo/logs:/var/log/mongodb:Z"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    command: ['--logpath', '/var/log/mongodb/mongodb.log']
    networks:
      - visp-net

  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    restart: unless-stopped
    ports:
      - 127.0.0.1:8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: $MONGO_ROOT_PASSWORD
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_BASICAUTH_USERNAME: mongo
      ME_CONFIG_BASICAUTH_PASSWORD: bongo
    networks:
      - visp-net

  whisper:
    build:
      context: ./docker/whisper
      dockerfile: Dockerfile
    image: visp-whisper
    volumes:
      - ./mounts/whisper/models:/Whisper-WebUI/models
      - ./mounts/whisper/outputs:/Whisper-WebUI/outputs
    networks:
      - whisper-net


networks:
  visp-net:
  whisper-net:  # Whisper network, without internet access
    internal: true
  octra-net:  # Octra network, without internet access
    internal: true
