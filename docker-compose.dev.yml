version: '3'
services:
  edge-router:
    image: hs-edge-router
    build: "./docker/edge-router"
    restart: unless-stopped
    depends_on:
      - keycloak
    networks:
      - visp-net
    ports:
      - $HTTP_PORT:80
      - $HTTPS_PORT:443
    environment:
      PROJECT_NAME: $PROJECT_NAME
      LOG_LEVEL: debug
      HS_DOMAIN_NAME: $BASE_DOMAIN
      GITLAB_DOMAIN_NAME: gitlab.$BASE_DOMAIN
      RSTUDIO_DOMAIN_NAME: rstudio.$BASE_DOMAIN
      KEYCLOAK_DOMAIN_NAME: idp.$BASE_DOMAIN
      HS_API_ACCESS_TOKEN: $HS_API_ACCESS_TOKEN
      GIT_API_ACCESS_TOKEN: $GIT_API_ACCESS_TOKEN
      ABS_ROOT_PATH: $ABS_ROOT_PATH
      MONGO_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
    volumes:
      #Shibboleth config for SWAMID
      #- "./mounts/edge-router/saml/swamid/apache-shibboleth2.xml:/etc/shibboleth/shibboleth2.xml:Z"
      #- "./mounts/edge-router/saml/swamid/idp-transitive.xml:/etc/shibboleth/swamid-idp-transitive.xml:Z"
      #- "./mounts/edge-router/saml/swamid/attribute-map.xml:/etc/shibboleth/attribute-map.xml:Z"
      #- "./mounts/edge-router/saml/certs/swamid-metadata-signer.crt:/etc/shibboleth/swamid-metadata-signer.crt:Z"
      #- "./private/certs/sp-cert/hird.humlab.umu.se-cert.pem:/etc/shibboleth/sp-cert.pem:Z"
      #- "./private/certs/sp-cert/hird.humlab.umu.se-key.pem:/etc/shibboleth/sp-key.pem:Z"
      #Shibboleth config for KEYCLOAK
      - "./mounts/edge-router/saml/keycloak/$BASE_DOMAIN/shibboleth2.xml:/etc/shibboleth/shibboleth2.xml:Z"
      - "./mounts/edge-router/saml/keycloak/attribute-map.xml:/etc/shibboleth/attribute-map.xml:Z"
      - "./mounts/edge-router/saml/certs/keycloak-metadata-signer.crt:/etc/shibboleth/metadata-signer.crt:Z"
      - "./mounts/edge-router/saml/keycloak/keycloak-idp-metadata.xml:/etc/shibboleth/keycloak-idp-metadata.xml:Z"
      #GENERAL
      - "./mounts/webapi/logs:/var/log/api:Z"
      - "./mounts/edge-router/saml/shib.conf:/etc/apache2/conf-enabled/shib.conf:Z"
      - "./mounts/edge-router/apache/envvars:/etc/apache2/envvars:Z"
      - "./mounts/edge-router/apache/apache2.conf:/etc/apache2/apache2.conf:Z"
      - "./mounts/edge-router/apache/vhosts/:/etc/apache2/sites-enabled/:Z"
      - "./webclient/dist:/var/www/html:Z"
      - "./webapi:/var/www/html/api:Z"
      - "./mounts/edge-router/apache/logs/apache2:/var/log/apache2:Z"
      - "./mounts/edge-router/apache/logs/shibboleth:/var/log/shibboleth:Z"
      - "./mounts/edge-router/saml/shibd.logger:/etc/shibboleth/shibd.logger:Z"
      - "/var/run/docker.sock:/var/run/docker.sock:Z"
      - "./certs:/etc/certs:Z"
      - "./certs/letsencrypt:/certs/letsencrypt:Z"
      - "./mounts/edge-router/apache/uploads:/tmp/uploads:Z"
      - "./mounts/edge-router/apache/php.ini:/etc/php/7.3/apache2/php.ini:Z"      

  session-manager:
    image: hs-session-manager-dev
    build: "./docker/session-manager/dev"
    restart: unless-stopped
    environment:
      HS_API_ACCESS_TOKEN: $HS_API_ACCESS_TOKEN
      GIT_API_ACCESS_TOKEN: $GIT_API_ACCESS_TOKEN
      ABS_ROOT_PATH: $ABS_ROOT_PATH
      RSTUDIO_IMAGE_NAME: "visp-rstudio-session"
      RSTUDIO_PASSWORD: $RSTUDIO_PASSWORD
      JUPYTER_IMAGE_NAME: "visp-jupyter-session"
      GITLAB_ADDRESS: "http://gitlab:80"
      MONGO_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
      LOG_LEVEL: "debug"
    volumes:
      - "./mounts/edge-router/apache/uploads:/mounts/edge-router/apache/uploads:Z"
      - "./session-manager:/session-manager:Z"
      - "/var/run/docker.sock:/var/run/docker.sock:Z"
    networks:
      - visp-net

  gitlab:
    image: hs-gitlab
    build: "./docker/gitlab"
    restart: unless-stopped
    networks:
      - visp-net
    hostname: gitlab.$BASE_DOMAIN
    environment:
      GITLAB_DOMAIN_NAME: gitlab.$BASE_DOMAIN
      HS_DOMAIN_NAME: $BASE_DOMAIN
      HS_AUTH_REALM: $AUTH_REALM
      KEYCLOAK_SIGNING_CERT_FINGERPRINT: $KEYCLOAK_SIGNING_CERT_FINGERPRINT
      GITLAB_ROOT_PASSWORD: $GITLAB_ROOT_PASSWORD
      GITLAB_OMNIAUTH_AUTO_SIGN_IN_WITH_PROVIDER: $GITLAB_OMNIAUTH_AUTO_SIGN_IN_WITH_PROVIDER
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.$BASE_DOMAIN'
        gitlab_rails['initial_root_password'] = '$GITLAB_ROOT_PASSWORD'
    volumes:
      - "$GITLAB_HOME/data:/var/opt/gitlab:Z"
      - "$GITLAB_HOME/config:/etc/gitlab:Z"
      - "$GITLAB_HOME/apache-logs:/var/log/apache2:Z"
      - "$GITLAB_HOME/shibboleth-logs:/var/log/shibboleth:Z"
      - "$GITLAB_HOME/apache2.conf:/etc/apache2/apache2.conf:Z"
      - "$GITLAB_HOME/gitlab-apache24.conf:/etc/apache2/sites-enabled/gitlab-apache24.conf:Z"
      - "$GITLAB_HOME/gitlab-apache24-ssl.conf:/etc/apache2/sites-enabled/gitlab-apache24-ssl.conf:Z"
      - "$GITLAB_HOME/public:/opt/gitlab/public:Z"
      - "$GITLAB_HOME/envvars:/etc/apache2/envvars:Z"
      #- "$GITLAB_HOME/postgresql.conf:/var/opt/gitlab/postgresql/data/postgresql.conf:Z"
      #- "$GITLAB_HOME/postgresql.conf:/var/opt/gitlab/postgresql/data.11/postgresql.conf:Z"
      - "./certs:/etc/certs:Z"

  emu-webapp:
    image: hs-emu-webapp
    build: "./docker/emu-webapp"
    restart: unless-stopped
    ports:
      - 9000:9000
    networks:
      - visp-net

  octra:
    image: hs-octra
    build: "./docker/octra"
    restart: unless-stopped
    volumes:
      - "./mounts/octra/appconfig.json:/usr/local/apache2/htdocs/config/appconfig.json:Z"
      - "./mounts/octra/httpd.conf:/usr/local/apache2/conf/httpd.conf:Z"
    networks:
      - visp-net
    volumes:
      - "./mounts/octra/appconfig.json:/usr/local/apache2/htdocs/config/appconfig.json:Z"
      - "./mounts/octra/httpd.conf:/usr/local/apache2/conf/httpd.conf:Z"

  #wsr-client:
  #  image: hs-wsr-client
  #  build: "./docker/hs-wsr-client"
  #  volumes:
  #    - "./hs-wsr-client/dist:/usr/local/apache2/htdocs:Z"
  #    - "./hs-wsr-client/.htaccess:/usr/local/apache2/htdocs/.htaccess:Z"
  #    - "./hs-wsr-client/httpd.conf:/usr/local/apache2/conf/httpd.conf:Z"
  #  networks:
  #    - visp-net

  #wsr-server:
  #  image: hs-wsr-server
  #  build: "./docker/hs-wsr-server"
  #  volumes:
  #    - "./hs-wsr-server:/hs-wsr-server:Z"
  #  networks:
  #    - visp-net

  labjs:
    image: hs-labjs
    build: "./docker/labjs"
    restart: unless-stopped
    networks:
      - visp-net

  keycloak:
    image: hs-keycloak
    build: "./docker/keycloak"
    restart: unless-stopped
    depends_on:
      - database
    environment:
      KEYCLOAK_USER: $KEYCLOAK_USER
      KEYCLOAK_PASSWORD: $KEYCLOAK_PASSWORD
      KEYCLOAK_FRONTEND_URL: "https://idp.$BASE_DOMAIN/auth/"
      DB_VENDOR: "postgres"
      DB_ADDR: "database"
      DB_USER: "keycloak"
      DB_PASSWORD: $POSTGRES_PASSWORD
      KEYCLOAK_LOGLEVEL: "INFO"
      ROOT_LOGLEVEL: "INFO"
      PROXY_ADDRESS_FORWARDING: "true"
    volumes:
      - "./mounts/keycloak/themes/visp:/opt/jboss/keycloak/themes/visp:Z"
    networks:
      - visp-net

  database:
    image: postgres:12.5
    restart: unless-stopped
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: $POSTGRES_PASSWORD
      POSTGRES_DB: keycloak
      PGDATA: '/pgdata/data'
    volumes:
      - "./mounts/postgresql/data:/pgdata:Z"
    networks:
      - visp-net

  mongo:
    image: mongo:4.4.4
    restart: unless-stopped
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
    volumes:
      - "./mounts/mongo/data:/data/db:Z"
    networks:
      - visp-net
    
  mongo-express:
    image: mongo-express
    restart: unless-stopped
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: $MONGO_ROOT_PASSWORD
    networks:
      - visp-net

networks:
  visp-net:

