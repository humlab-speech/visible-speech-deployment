# VISP Complete Deployment Guide

This guide covers deploying Visible Speech (VISP) in both development (local) and production (with DNS) environments.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Start with visp_deploy.py](#quick-start-with-visp_deploypy)
3. [Development Deployment (Local)](#development-deployment-local)
4. [Production Deployment (with DNS)](#production-deployment-with-dns)
5. [Adding a New Deployment Domain](#adding-a-new-deployment-domain)
6. [Post-Installation Configuration](#post-installation-configuration)
7. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### System Requirements

- **OS**: Debian-based Linux (Ubuntu, Debian)
- **Docker**: Version 20.10+
- **Docker Compose**: Version 2.0+
- **Python**: Version 3.8+
- **Git**: For cloning repositories
- **OpenSSL**: For certificate generation

### Install Dependencies

```bash
# Debian/Ubuntu
sudo apt update
sudo apt install -y curl git openssl docker.io docker-compose python3 python3-pip

# Add user to docker group (logout/login required)
sudo usermod -aG docker $USER

# Install optional Python dependencies
pip3 install tabulate
```

### Storage Requirements

- **Development**: ~10GB (includes node_modules, Docker images)
- **Production**: ~5GB (no source code mounted)

---

## Quick Start with visp_deploy.py

The `visp_deploy.py` script automates most deployment tasks. It handles:

- ✅ Cloning all required repositories
- ✅ Installing npm dependencies (in Docker containers)
- ✅ Building frontend applications (in Docker containers)
- ✅ Generating SSL certificates
- ✅ Creating required directories and logs
- ✅ Auto-generating secure passwords
- ✅ Setting correct file permissions

### Installation Commands

**Development Mode** (with source code mounts for hot-reload):
```bash
cd visible-speech-deployment
sudo python3 visp_deploy.py install --mode=dev
```

**Production Mode** (code baked into Docker images):
```bash
cd visible-speech-deployment
sudo python3 visp_deploy.py install --mode=prod
```

### Other Useful Commands

```bash
# Check status of all repositories
python3 visp_deploy.py status

# Update all repositories and rebuild components
python3 visp_deploy.py update

# Force update (stash uncommitted changes)
python3 visp_deploy.py update --force
```

---

## Development Deployment (Local)

Development mode is ideal for:
- Local testing with `visp.local` domain
- Hot-reload development (source code mounted)
- Quick iteration without rebuilding Docker images

### Step 1: Clone Deployment Repository

```bash
git clone https://github.com/humlab-speech/visible-speech-deployment.git
cd visible-speech-deployment
```

### Step 2: Configure .env File

The install script will create `.env` from `.env-example`, but you should review and customize it:

```bash
# Edit .env file
nano .env
```

**Key settings for local development:**

```bash
# Domain configuration
BASE_DOMAIN=visp.local

# Webclient build configuration (MUST match BASE_DOMAIN)
# For local dev, use visp-build or leave default
WEBCLIENT_BUILD=visp-build

# Project name
COMPOSE_PROJECT_NAME=visp
PROJECT_NAME=Visible Speech

# Admin email (for error notifications)
ADMIN_EMAIL=admin@visp.local

# HTTP/HTTPS ports
HTTP_PORT=80
HTTPS_PORT=443
HTTP_PROTOCOL=https

# Feature flags
ACCESS_LIST_ENABLED=false
EMUDB_INTEGRATION_ENABLED=true

# Absolute path (auto-set by install script)
ABS_ROOT_PATH=/home/user/visible-speech-deployment

# Passwords (auto-generated by install script)
POSTGRES_PASSWORD=<auto-generated>
VISP_API_ACCESS_TOKEN=<auto-generated>
MONGO_ROOT_PASSWORD=<auto-generated>
TEST_USER_LOGIN_KEY=<auto-generated>
RSTUDIO_PASSWORD=<auto-generated>
# ... more passwords ...
```

### Step 3: Run Installation Script

```bash
sudo python3 visp_deploy.py install --mode=dev
```

**What this does:**
1. Creates `.env` with auto-generated passwords
2. Creates `docker-compose.yml` symlink to `docker-compose.dev.yml`
3. Generates self-signed SSL certificates for `visp.local`
4. Clones all repositories to `external/` directory
5. Builds all Node.js components using Docker containers
6. Creates required directories and log files

### Step 4: Configure Local DNS

Add to `/etc/hosts`:

```bash
sudo nano /etc/hosts
```

Add these lines:

```
127.0.0.1 visp.local
127.0.0.1 emu-webapp.visp.local
127.0.0.1 octra.visp.local
127.0.0.1 rstudio.visp.local
127.0.0.1 jupyter.visp.local
```

### Step 5: Build and Start Services

```bash
# Build Docker images
docker compose build

# Start all services
docker compose up -d

# Check status
docker compose ps
```

### Step 6: Verify Installation

```bash
# Check deployment status
python3 visp_deploy.py status

# Expected output should show:
# - All repositories cloned and clean
# - WEBCLIENT_BUILD matches BASE_DOMAIN
# - No uncommitted changes (unless you made edits)
```

### Step 7: Access the Application

Open browser to: **https://visp.local**

- Accept self-signed certificate warning
- Use test user login: `https://visp.local/?login=<TEST_USER_LOGIN_KEY>`
- (Get `TEST_USER_LOGIN_KEY` from `.env` file)

---

## Production Deployment (with DNS)

Production mode is for:
- Internet-accessible deployments with real DNS
- Multiple deployment environments (prod, demo, staging)
- Security-hardened configuration
- No source code on production servers

### Step 1: DNS and Server Setup

**Before starting, ensure:**
- Server has public IP address
- DNS records are configured:
  - `yourdomain.com` → server IP
  - `*.yourdomain.com` → server IP (wildcard for subdomains)
  - Or explicit records for: `emu-webapp`, `octra`, `rstudio`, `jupyter`

**Example DNS for `visp.pdf-server.humlab.umu.se`:**
```
visp.pdf-server.humlab.umu.se        A    130.239.XXX.XXX
*.visp.pdf-server.humlab.umu.se      A    130.239.XXX.XXX
```

### Step 2: Clone Deployment Repository

```bash
ssh user@your-server.com
git clone https://github.com/humlab-speech/visible-speech-deployment.git
cd visible-speech-deployment
```

### Step 3: Configure .env File

```bash
nano .env
```

**Critical settings for production:**

```bash
# YOUR ACTUAL DOMAIN
BASE_DOMAIN=visp.pdf-server.humlab.umu.se

# MUST MATCH YOUR DOMAIN - this is build-time configuration!
# See "Adding a New Deployment Domain" if your domain isn't listed
WEBCLIENT_BUILD=visp-pdf-server-build

# Project identification
COMPOSE_PROJECT_NAME=visp
PROJECT_NAME=Visible Speech

# Real admin email
ADMIN_EMAIL=admin@yourdomain.com

# Production ports
HTTP_PORT=80
HTTPS_PORT=443
HTTP_PROTOCOL=https

# Feature flags
ACCESS_LIST_ENABLED=true  # Enable for production
EMUDB_INTEGRATION_ENABLED=true

# IMPORTANT: Set strong passwords or let install script generate them
# For existing MongoDB, keep the current MONGO_ROOT_PASSWORD!
```

### Step 4: Check if Domain Has Webclient Configuration

**Important:** The webclient must have an environment file matching your domain!

```bash
# Check if your domain configuration exists
ls external/webclient/src/environments/environment.*.ts

# Should include a file matching your WEBCLIENT_BUILD
# For visp-pdf-server-build, look for:
#   environment.visp-pdf-server.ts
```

**If your domain is NOT listed**, see [Adding a New Deployment Domain](#adding-a-new-deployment-domain)

### Step 5: Run Production Installation

```bash
sudo python3 visp_deploy.py install --mode=prod
```

**Production mode differences:**
- Creates `docker-compose.yml` → `docker-compose.prod.yml` symlink
- Source code is **baked into images**, not mounted
- Requires `docker compose build` after any code changes
- More secure - no source code on production filesystem

### Step 6: Configure SSL Certificates

**Option A: Let's Encrypt (Recommended for production)**

The deployment includes Traefik which can automatically obtain Let's Encrypt certificates:

```bash
# Edit Traefik configuration
nano mounts/traefik/conf/traefik.yml

# Ensure these settings:
certificatesResolvers:
  letsencrypt:
    acme:
      email: your-email@domain.com
      storage: /acme/acme.json
      httpChallenge:
        entryPoint: web
```

**Option B: Custom Certificates**

```bash
# Place your certificates in:
mkdir -p certs/yourdomain.com
cp your-cert.crt certs/yourdomain.com/cert.crt
cp your-key.key certs/yourdomain.com/cert.key
```

### Step 7: Configure Shibboleth/SWAMID (if using)

For production deployments using SWAMID authentication:

```bash
# Configure Shibboleth
nano mounts/apache/saml/swamid/$BASE_DOMAIN/shibboleth2.xml

# Update entityID, hostname, etc. to match your domain
```

### Step 8: Build and Deploy

```bash
# Build all Docker images (this takes 10-20 minutes)
docker compose build

# Verify webclient was built with correct domain
python3 visp_deploy.py status

# Start services
docker compose up -d

# Monitor logs
docker compose logs -f apache
```

### Step 9: Post-Deployment Verification

```bash
# Check all services are running
docker compose ps

# Check deployment configuration
python3 visp_deploy.py status

# Expected status output:
# ✅ WEBCLIENT_BUILD matches BASE_DOMAIN
# ✅ Actual Build contains correct domain
# ✅ All repositories clean
```

### Step 10: Test Access

1. **Test from external network**: `https://yourdomain.com`
2. **Check browser DevTools Network tab**:
   - WebSocket should connect to `wss://yourdomain.com/`
   - API calls should go to `https://yourdomain.com/api/v1/`
3. **Test authentication** (if using TEST_USER_LOGIN_KEY):
   ```
   https://yourdomain.com/?login=<TEST_USER_LOGIN_KEY>
   ```

---

## Adding a New Deployment Domain

If you're deploying to a domain that doesn't have a webclient configuration yet:

### Step 1: Create Environment File

```bash
cd external/webclient/src/environments/

# Copy an existing environment file
cp environment.visp-demo.ts environment.your-domain.ts

# Edit the new file
nano environment.your-domain.ts
```

**Update these fields:**

```typescript
export const environment = {
  production: true,

  // CHANGE THIS to your domain
  API_ENDPOINT: 'your-domain.com',

  // CHANGE THIS to your domain
  BASE_DOMAIN: 'your-domain.com',

  // Keep these as-is
  WS_PORT: 443,
  WS_PROTOCOL: 'wss://',
  API_PROTOCOL: 'https://',
  API_PORT: 443,
  // ... rest of file ...
};
```

### Step 2: Add npm Build Script

```bash
cd external/webclient

# Edit package.json
nano package.json
```

Add to the `"scripts"` section:

```json
{
  "scripts": {
    "your-domain-build": "ng build --configuration=your-domain --output-path dist",
    // ... other scripts ...
  }
}
```

### Step 3: Add Angular Configuration

```bash
# Edit angular.json
nano angular.json
```

Find the `"configurations"` section under `"build"`, and add:

```json
"your-domain": {
  "sourceMap": true,
  "optimization": {
    "styles": {
      "inlineCritical": false
    }
  },
  "fileReplacements": [
    {
      "replace": "src/environments/environment.ts",
      "with": "src/environments/environment.your-domain.ts"
    }
  ]
},
```

### Step 4: Update Deployment .env

```bash
cd /path/to/visible-speech-deployment
nano .env
```

Set:
```bash
BASE_DOMAIN=your-domain.com
WEBCLIENT_BUILD=your-domain-build
```

### Step 5: Commit Changes to Webclient Repo

```bash
cd external/webclient

git add src/environments/environment.your-domain.ts
git add package.json
git add angular.json
git commit -m "Add configuration for your-domain.com"
git push origin master
```

### Step 6: Build and Deploy

```bash
cd /path/to/visible-speech-deployment

# Build Docker images with new configuration
docker compose build apache

# Verify configuration
python3 visp_deploy.py status

# Deploy
docker compose up -d apache
```

---

## Post-Installation Configuration

### MongoDB Setup

After first startup, initialize MongoDB users:

```bash
# Access MongoDB through mongo-express
# URL: http://localhost:28084
# Username: mongo
# Password: <MONGO_EXPRESS_PASSWORD from .env>

# Or use mongo shell
docker exec -it visp-mongo-1 mongosh -u root -p <MONGO_ROOT_PASSWORD>

# Create necessary collections (if not auto-created)
use visp
db.createCollection("users")
db.createCollection("sessions")
```

### Configure Test User for Development

For development/demo deployments using TEST_USER_LOGIN_KEY:

```bash
# The test user is auto-created on first login via ?login=<key>
# To manually configure in MongoDB:

docker exec -it visp-mongo-1 mongosh -u root -p <MONGO_ROOT_PASSWORD>

use visp

db.users.updateOne(
  { username: "testuser_at_example_dot_com" },
  {
    $set: {
      loginAllowed: true,
      email: "testuser@example.com",
      displayName: "Test User"
    }
  },
  { upsert: true }
)
```

### Configure Matomo Analytics (Optional)

```bash
# Access Matomo setup
# URL: https://yourdomain.com/matomo

# Database settings:
# - Host: matomo-db
# - Database: matomo_db (from .env: MATOMO_DB_NAME)
# - Username: <MATOMO_DB_USER from .env>
# - Password: <MATOMO_DB_PASSWORD from .env>
```

### Configure Reverse Proxy Headers

The apache service is behind Traefik. Ensure proper headers are set:

```bash
# Check mounts/apache/apache/vhosts/000-default.conf
# Should include:
SetEnvIf X-Forwarded-Proto https HTTPS=on
RequestHeader set X-Forwarded-Proto "https"
```

---

## Troubleshooting

### WebSocket Connection Fails

**Symptom**: Browser console shows `WebSocket connection to 'wss://wrong-domain.com/' failed`

**Cause**: Webclient built with wrong domain configuration

**Solution**:
```bash
# Check configuration
python3 visp_deploy.py status

# Should show MISMATCH warning if incorrect
# Update .env with correct WEBCLIENT_BUILD
nano .env

# Rebuild apache image
docker compose build apache

# Restart
docker compose up -d apache
```

### API Returns 401 Unauthorized

**Symptom**: User logs in but API calls fail with 401

**Cause**: MongoDB user has `loginAllowed: false`

**Solution**:
```bash
# Update MongoDB user
docker exec -it visp-mongo-1 mongosh -u root -p <MONGO_ROOT_PASSWORD>

use visp
db.users.updateOne(
  { username: "your_username" },
  { $set: { loginAllowed: true } }
)
```

### "e is null" Error in Browser

**Symptom**: JavaScript error "can't access property 'eppn', e is null"

**Cause**: Wrong webclient build configuration - API returning data but Angular app can't parse it

**Solution**: Same as WebSocket issue - rebuild with correct domain

### Apache Container Has Empty /var/www/html

**Symptom**: Accessing site shows 404 or empty page

**Cause**: Docker build didn't complete webclient build

**Solution**:
```bash
# Rebuild with no cache
docker compose build --no-cache apache

# Check build logs
docker compose build apache 2>&1 | grep -A 5 "npm run"

# Should see: "RUN npm run visp-build" or similar
```

### Permission Errors

**Symptom**: `PermissionError: [Errno 1] Operation not permitted`

**Solutions**:
```bash
# For production
sudo python3 visp_deploy.py install

# For development (warnings OK)
python3 visp_deploy.py install

# Fix existing permissions
sudo chown -R $USER:$USER external/
sudo chown -R $USER:$USER mounts/
```

### MongoDB Connection Refused

**Symptom**: Services can't connect to MongoDB

**Solution**:
```bash
# Check MongoDB is running
docker compose ps mongo

# Check logs
docker compose logs mongo

# If password changed, update all .env files:
# - Main .env: MONGO_ROOT_PASSWORD
# - external/wsrng-server/.env: MONGO_PASSWORD
# - mounts/emu-webapp-server/.env: MONGO_URI
```

### Traefik Not Routing Correctly

**Symptom**: 404 errors or wrong service responses

**Solution**:
```bash
# Check Traefik configuration
docker compose logs traefik

# Verify docker-compose labels on services
docker inspect <service-name> | grep traefik

# Restart Traefik
docker compose restart traefik
```

### Repository Status Shows Uncommitted Changes

**Symptom**: `visp_deploy.py status` shows ⚠️ HAS CHANGES

**What it means**: Local modifications not committed to git

**Options**:
```bash
# Option 1: Commit your changes
cd external/webclient
git add .
git commit -m "Local configuration changes"

# Option 2: Stash changes before update
git stash

# Option 3: Force update (auto-stash)
python3 visp_deploy.py update --force
```

### Build Configuration Mismatch

**Symptom**: `visp_deploy.py status` shows ⚠️ MISMATCH

**What it means**:
- `.env` file has `WEBCLIENT_BUILD=visp-pdf-server-build`
- But `external/webclient/dist` contains `visp.humlab.umu.se` (wrong domain)

**Solution**:
```bash
# Update .env to match deployment
nano .env
# Set: WEBCLIENT_BUILD=visp-pdf-server-build
# Set: BASE_DOMAIN=visp.pdf-server.humlab.umu.se

# Rebuild apache image
docker compose build apache

# Verify fix
python3 visp_deploy.py status
# Should show: ✅ CORRECT
```

---

## Maintenance

### Regular Updates

```bash
# Check for updates
python3 visp_deploy.py status

# Update all repositories and rebuild
python3 visp_deploy.py update

# Rebuild Docker images
docker compose build

# Restart services
docker compose up -d
```

### Backup Important Data

```bash
# MongoDB data
sudo tar -czf mongo-backup-$(date +%Y%m%d).tar.gz mounts/mongo/data/

# Configuration files
sudo tar -czf config-backup-$(date +%Y%m%d).tar.gz .env mounts/apache/ certs/

# User repositories
sudo tar -czf repos-backup-$(date +%Y%m%d).tar.gz mounts/repositories/
```

### Monitoring

```bash
# Check all services
docker compose ps

# Check logs
docker compose logs -f --tail=100

# Check specific service
docker compose logs -f apache

# Check system resources
docker stats
```

---

## Quick Reference

### Common Commands

```bash
# Status check
python3 visp_deploy.py status

# Install (dev mode)
sudo python3 visp_deploy.py install --mode=dev

# Install (prod mode)
sudo python3 visp_deploy.py install --mode=prod

# Update system
python3 visp_deploy.py update

# Build images
docker compose build

# Start services
docker compose up -d

# Stop services
docker compose down

# View logs
docker compose logs -f

# Restart service
docker compose restart apache
```

### Important File Locations

```
visible-speech-deployment/
├── .env                          # Main configuration
├── docker-compose.yml            # Symlink to dev/prod
├── visp_deploy.py                # Deployment script
├── external/                     # Cloned repositories
│   ├── webclient/                # Angular frontend
│   │   └── src/environments/     # Domain configurations
│   ├── webapi/                   # PHP backend
│   ├── session-manager/          # Container orchestration
│   └── wsrng-server/             # WebSocket server
├── mounts/                       # Persistent data
│   ├── apache/                   # Apache configs & logs
│   ├── mongo/                    # MongoDB data
│   ├── repositories/             # User repositories
│   └── matomo/                   # Analytics data
├── certs/                        # SSL certificates
└── docker/                       # Dockerfiles
    └── apache/                   # Apache + webclient image
```

### Environment Variables Reference

| Variable | Purpose | Example |
|----------|---------|---------|
| `BASE_DOMAIN` | Deployment domain | `visp.pdf-server.humlab.umu.se` |
| `WEBCLIENT_BUILD` | Angular build config | `visp-pdf-server-build` |
| `HTTP_PROTOCOL` | Protocol to use | `https` |
| `TEST_USER_LOGIN_KEY` | Test auth bypass | `<random-string>` |
| `MONGO_ROOT_PASSWORD` | MongoDB password | `<random-string>` |
| `ACCESS_LIST_ENABLED` | Enable access control | `true` / `false` |

---

## Additional Resources

- **Webclient Build Configuration**: See `docs/WEBCLIENT_BUILD_CONFIG.md`
- **Version Management**: See `docs/VERSION_MANAGEMENT.md`
- **Folder Structure**: See `docs/FOLDER_STRUCTURE.md`
- **Dev vs Prod**: See `docs/DEV_VS_PROD.md`

---

## Support

For issues or questions:
1. Check this guide's [Troubleshooting](#troubleshooting) section
2. Run `python3 visp_deploy.py status` to diagnose issues
3. Check Docker logs: `docker compose logs <service-name>`
4. Review GitHub issues: https://github.com/humlab-speech/visible-speech-deployment/issues
